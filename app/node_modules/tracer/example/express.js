var tinytim = require('tinytim');

module.exports = function(logger, format) {
	var _format = "{{remote-addr}} - - {{date}} {{http-method}} {{url}} HTTP/:{{http-version}} {{status}} {{content-length}} {{referrer}} {{user-agent}}";
	if (format)
		_format = format;
	return function logger(req, res, next) {
		req._startTime = new Date;
	    // mount safety
	    if (req._logging) return next();

	    // flag as logging
	    req._logging = true;
	    
	    var _end = res.end;
		res.end = function(chunk, encoding){
	        res.end = _end;
	        res.end(chunk, encoding);
	        
			data = {};
			data["date"] = new Date().toUTCString();
			data["response-time"] = new Date - req._startTime;
			data["remote-addr"] = req.socket
					&& (req.socket.remoteAddress || (req.socket.socket && req.socket.socket.remoteAddress));
			data["http-method"] = req.method;
			data["url"] = req.originalUrl;
			data["http-version"] = req.httpVersionMajor + '.'
					+ req.httpVersionMinor;
			data["status"] = res.statusCode;
			data["content-length"] = (res._headers || {})['content-length'] || 0;
			data["referrer"] = req.headers['referer'] || req.headers['referrer'] || "";
			data["user-agent"] = req.headers['user-agent'];
			
			//console.log(data, req)

			logger(tinytim.tim(_format, data));
	      };
	      


		next();
	};
};
